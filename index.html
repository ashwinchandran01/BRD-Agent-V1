<!DOCTYPE html>
<html>
<head>
<title>GoComet | BRD AI Agent Frontend</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* Basic styles for the UI */
    :root {
        --bg: #f7fafc;
        --text: #111827;
        --muted: #6b7280;
        --primary: #2563eb;
        --border: #e5e7eb;
        --card: #ffffff;
        --accent: #10b981;
        --warn: #f59e0b;
        --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui,-apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
    header { position: sticky; top: 0; z-index: 10; background: var(--card); border-bottom: 1px solid var(--border); padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; }
    header .title { font-weight: 800; letter-spacing: 0.2px; }
    header .subtitle { font-size: 12px; color: var(--muted); }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; display: grid; grid-template-columns: 1.2fr 2fr; gap: 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
    .card .head { padding: 12px 14px; border-bottom: 1px solid var(--border); font-weight: 700; display:flex; align-items: center; justify-content: space-between; }
    .card .body { padding: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, textarea, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; font: inherit; }
    textarea { min-height: 100px; resize: vertical; }
    .btns { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn { cursor: pointer; border-radius: 10px; padding: 10px 12px; border: 1px solid var(--border); background: var(--card); font-weight: 600; }
    .btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn.accent { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn.warn { background: var(--warn); color: #fff; border-color: var(--warn); }
    .btn.danger { background: var(--danger); color: #fff; border-color: var(--danger); }
    .status { font-size: 12px; color: var(--muted); margin-left: auto; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 990px) { .container { grid-template-columns: 1fr; } .grid { grid-template-columns: 1fr; } }

    #brd-container { min-height: 400px; }
    #brd-content { line-height: 1.65; }
    #brd-content h1, #brd-content h2, #brd-content h3 { margin: 0.7em 0 0.4em; }
    #brd-content ul { padding-left: 1.2em; }

    .notif { position: fixed; right: 16px; bottom: 16px; display:flex; flex-direction: column; gap: 8px; z-index: 50; }
    .toast { background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow: 0 8px 24px rgba(0,0,0,.15); font-size: 13px; }
</style>
</head>
<body>
<header>
    <div>
        <div class="title">GoComet BRD AI Agent</div>
        <div class="subtitle">Generate, download, and edit Business Requirement Documents</div>
    </div>
    <div class="status" id="status">Ready</div>
</header>

<div class="container">
    <div class="card">
        <div class="head">Inputs</div>
        <div class="body">
            <div class="row">
                <div>
                    <label>Project Name</label>
                    <input id="projectName" placeholder="e.g., Diagnostics uplift for IPD/OPD">
                </div>
                <div>
                    <label>Owner</label>
                    <input id="owner" placeholder="e.g., Neeta / Ops">
                </div>
            </div>
            <div class="row">
                <div>
                    <label>Summary / Context</label>
                    <textarea id="summary" placeholder="Short context for BRD…"></textarea>
                </div>
                <div>
                    <label>Key Requirements</label>
                    <textarea id="requirements" placeholder="Bullets…"></textarea>
                </div>
            </div>
            <div class="btns" style="margin-top:8px;">
                <button class="btn primary" onclick="generateBRD()">Generate BRD</button>
                <button class="btn" onclick="openOpenAICanvas()">Open in canvas</button>
                <button class="btn accent" onclick="downloadBRD()">Download BRD</button>
            </div>
        </div>
    </div>

    <div class="card" id="brd-container">
        <div class="head">Preview</div>
        <div class="body">
            <div id="brd-content">Fill inputs and click Generate to see preview…</div>
        </div>
    </div>
</div>

<div class="notif" id="notif"></div>

<script>
const statusEl = document.getElementById('status');
const notif = document.getElementById('notif');

function setStatus(text) { statusEl.textContent = text; }
function showNotification(msg, type='info') {
  const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg;
  notif.appendChild(t); setTimeout(()=>{ t.remove(); }, 3000);
}

async function generateBRD() {
  const payload = {
    projectName: document.getElementById('projectName').value.trim(),
    owner: document.getElementById('owner').value.trim(),
    summary: document.getElementById('summary').value.trim(),
    requirements: document.getElementById('requirements').value.trim()
  };
  setStatus('Generating…');
  try {
    // Change to your n8n endpoint
    const res = await fetch('https://example.com/webhook/brd', {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept':'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    window.lastBRD = data; // keep the full server response
    const html = data.html || data.markdown || data.text || '<p>(no content)</p>';
    document.getElementById('brd-content').innerHTML = html;
    showNotification('BRD generated');
    setStatus('Ready');
  } catch (e) {
    console.error(e); setStatus('Error'); showNotification('Failed to generate BRD', 'error');
  }
}

function downloadBRD() {
  // Placeholder; real implementation added by patch below
  const html = document.getElementById('brd-content').innerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'GoComet-BRD.html'; a.click();
  URL.revokeObjectURL(url);
}

function openOpenAICanvas() {
  // Placeholder; real implementation added by patch below
  const w = window.open('', '_blank');
  w.document.write('<p>Canvas placeholder</p>');
  w.document.close();
}
</script>

<!-- >>> BEGIN GoComet BRD Patch (2025-08-15) -->
<script>
(() => {
  // Hold on to the latest BRD payload from n8n
  window.lastBRD = window.lastBRD || null;

  // Monkey-patch fetch to capture JSON responses that look like our BRD.
  const _fetch = window.fetch;
  window.fetch = async function(...args) {
    const res = await _fetch.apply(this, args);
    try {
      const clone = res.clone();
      const ct = (clone.headers && clone.headers.get && clone.headers.get('content-type')) || '';
      if (ct.includes('application/json')) {
        const data = await clone.json();
        if (data && (data.download_url || data.html || data.markdown || data.text)) {
          window.lastBRD = data;
        }
      }
    } catch (e) {
      // ignore
    }
    return res;
  };

  // Override: reliable .doc download using n8n's encoded output
  window.downloadBRD = function downloadBRD() {
    try {
      if (window.lastBRD && window.lastBRD.download_url) {
        const a = document.createElement('a');
        a.href = window.lastBRD.download_url;
        a.download = window.lastBRD.filename || 'GoComet-BRD.doc';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        if (window.showNotification) {
          window.showNotification('Downloading BRD (.doc) from server output…', 'info');
        }
        return;
      }
    } catch (e) {
      // fall through to HTML fallback
    }

    // Fallback: package current HTML content for download
    const brdEl = document.getElementById('brd-content') || document.querySelector('[data-brd-content], #brd, main');
    const bodyHtml = brdEl ? brdEl.innerHTML : document.body.innerHTML;
    const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>GoComet BRD</title></head><body>${bodyHtml}</body></html>`;
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'GoComet-BRD.html'; a.click();
    URL.revokeObjectURL(url);
    if (window.showNotification) {
      window.showNotification('Downloading BRD (HTML fallback)…', 'info');
    }
  };

  // Override: open an in-app "canvas" editor with optional Gemini wiring via n8n
  window.openOpenAICanvas = function openOpenAICanvas() {
    const contentEl = document.getElementById('brd-content') || document.querySelector('[data-brd-content], #brd, main');
    const content = contentEl ? contentEl.innerHTML : '<p>(empty)</p>';
    const w = window.open('', '_blank', 'noopener,noreferrer,width=1280,height=820');
    const safeBRD = content;

    w.document.write(`<!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8"/>
      <title>BRD Canvas</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        :root { --b:#e2e8f0; --bg:#f8fafc; --card:#fff; }
        * { box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); margin:0; }
        .wrap { display:grid; grid-template-columns: 2fr 1fr; gap:16px; padding:16px; }
        .editor { background:var(--card); border:1px solid var(--b); border-radius:12px; padding:16px; height:80vh; overflow:auto; }
        .editor[contenteditable="true"] { outline:none; }
        .panel { background:var(--card); border:1px solid var(--b); border-radius:12px; padding:16px; height:80vh; display:flex; flex-direction:column; }
        .controls { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px; }
        .btn { padding:10px 12px; border-radius:10px; border:1px solid var(--b); background:#0ea5e9; color:#fff; font-weight:600; cursor:pointer; }
        .btn.secondary { background:#6366f1; }
        .btn.ghost { background:#fff; color:#0f172a; }
        textarea { width:100%; min-height:120px; resize:vertical; font:inherit; padding:10px; border-radius:10px; border:1px solid var(--b); }
        .chat { flex:1; overflow:auto; border-top:1px solid var(--b); margin-top:8px; padding-top:8px; font-size:14px; }
        .msg { padding:8px; border-radius:8px; margin:6px 0; }
        .user { background:#f1f5f9; }
        .ai { background:#eff6ff; }
      </style>
    </head>
    <body>
      <div class="wrap">
        <div id="canvas" class="editor" contenteditable="true">${safeBRD}</div>
        <div class="panel">
          <div class="controls">
            <button class="btn" id="apply">Apply suggestion</button>
            <button class="btn secondary" id="downloadDoc">Download .doc</button>
            <button class="btn ghost" id="copyHtml">Copy HTML</button>
          </div>
          <label style="font-weight:600;">Ask Gemini to revise:</label>
          <textarea id="prompt" placeholder="e.g., Tighten Objectives to two sentences and make Success Criteria measurable."></textarea>
          <div class="chat" id="chat"></div>
        </div>
      </div>
      <script>
        const chat = document.getElementById('chat');
        const promptEl = document.getElementById('prompt');
        const canvas = document.getElementById('canvas');

        function postMsg(text, who) {
          const div = document.createElement('div');
          div.className = 'msg ' + (who === 'ai' ? 'ai' : 'user');
          div.textContent = text;
          chat.appendChild(div);
          chat.scrollTop = chat.scrollHeight;
        }

        document.getElementById('apply').onclick = async () => {
          const prompt = promptEl.value.trim();
          if (!prompt) return;
          postMsg(prompt, 'user');

          // TODO: Wire this to your n8n Vertex/Gemini webhook to return revised HTML.
          // Example:
          // const res = await fetch('https://<your-n8n>/webhook/brd-refine', {
          //   method: 'POST',
          //   headers: {'Content-Type':'application/json', 'Accept':'application/json'},
          //   body: JSON.stringify({ html: canvas.innerHTML, prompt })
          // });
          // const data = await res.json(); // { html: "<updated...>" }
          // canvas.innerHTML = data.html;

          postMsg('Sent to Gemini (demo). Replace with your n8n refine endpoint to get real edits back.', 'ai');
        };

        document.getElementById('downloadDoc').onclick = () => {
          try {
            const openerData = window.opener && window.opener.lastBRD;
            if (openerData && openerData.download_url) {
              const a = document.createElement('a');
              a.href = openerData.download_url;
              a.download = openerData.filename || 'GoComet-BRD.doc';
              a.click();
              return;
            }
          } catch {}
          const html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>GoComet BRD</title></head><body>' + canvas.innerHTML + '</body></html>';
          const blob = new Blob([html], {type:'text/html'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'GoComet-BRD.html'; a.click();
          URL.revokeObjectURL(url);
        };

        document.getElementById('copyHtml').onclick = async () => {
          await navigator.clipboard.writeText(canvas.innerHTML);
          postMsg('Copied current HTML to clipboard.', 'ai');
        };
      <\/script>
    </body>
    </html>`);
    w.document.close();
  };
})();
</script>
<!-- <<< END GoComet BRD Patch -->

</body>
</html>
