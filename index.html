<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GoComet BRD AI Agent</title>
<style>
/* --- your entire CSS from before --- */
</style>
</head>
<body>
<div class="container">
    <!-- your header + tabs + upload UI exactly as before -->
</div>

<!-- Notification -->
<div id="notification" class="notification"></div>

<script>
// -------------------- State --------------------
let uploadedFiles = { solution: [], flowchart: [] };
let processingInterval = null;
let currentProgress = 0;

const CONFIG = {
    n8nWebhookUrl: 'https://n8n.delivery-pre-uat.gocomet.com/webhook/e24fafe0-14a1-4c59-9c93-0077bd1684ce',
    timeout: 300000,
    maxFileSize: 10 * 1024 * 1024,
    allowedFileTypes: {
        solution: ['.pdf', '.docx', '.doc', '.txt', '.md'],
        flowchart: ['.png', '.jpg', '.jpeg', '.pdf', '.svg']
    }
};

// -------------------- Tab + Upload handling (unchanged) --------------------
// ... all your switchTab, drag/drop, file preview, notifications, setProgress, startFakeProcessing, finishProcessing, renderBRD from before ...

// -------------------- BRD Generation --------------------
async function generateBRD() {
  try {
    if ((uploadedFiles.solution.length + uploadedFiles.flowchart.length) === 0) {
      showNotification('Please add at least one file.', 'error');
      return;
    }

    startFakeProcessing();

    const fd = new FormData();
    const appendFileVariants = (name, file) => {
      fd.append(name, file, file.name);
      fd.append(`${name}[]`, file, file.name);
    };

    uploadedFiles.solution.forEach((f, i) => {
      appendFileVariants('solution_docs', f);
      appendFileVariants('files', f);
      appendFileVariants('file', f);
      fd.append(`solution_docs[${i}]`, f, f.name);
    });
    uploadedFiles.flowchart.forEach((f, i) => {
      appendFileVariants('visual_assets', f);
      appendFileVariants('images', f);
      appendFileVariants('image', f);
      fd.append(`visual_assets[${i}]`, f, f.name);
    });
    fd.append('source', 'gocomet-brd-ui');

    const controller = new AbortController();
    const to = setTimeout(() => controller.abort(), CONFIG.timeout);

    let res, raw = '';
    try {
      res = await fetch(CONFIG.n8nWebhookUrl, {
        method: 'POST',
        body: fd,
        signal: controller.signal,
      });
      raw = await res.text();
    } catch (e) {
      clearTimeout(to);
      showNotification(`Network error: ${e.message}`, 'error');
      throw e;
    }
    clearTimeout(to);

    let data = {};
    try { data = JSON.parse(raw); } catch { data = { text: raw }; }
    if (typeof data === 'string') { try { data = JSON.parse(data); } catch {} }
    if (Array.isArray(data)) data = data[0] || {};

    window.lastBRD = data;
    console.log('[BRD] lastBRD →', data);

    if (!res.ok) {
      showNotification(`HTTP ${res.status}: ${raw.slice(0, 300)}`, 'error');
      throw new Error(`HTTP ${res.status}`);
    }

    const content = data.html ?? data.markdown ?? data.text ?? '';
    if (!content) {
      showNotification(`No BRD content in response. Body starts: ${raw.slice(0, 120)}`, 'error');
      throw new Error('Missing html/markdown/text in response');
    }

    setProgress(97);
    renderBRD(content, !!data.markdown);
    finishProcessing();

  } catch (err) {
    clearInterval(processingInterval);
    console.error(err);
    setProgress(0);
    document.getElementById('progress-title').textContent = 'Processing failed';
    document.getElementById('progress-description').textContent = 'Please try again or contact support.';
    showNotification(`Failed to generate BRD: ${err.message}`, 'error');
  }
}

// -------------------- Actions --------------------
function openOpenAICanvas() {
    const w = window.open();
    w.document.write('<!DOCTYPE html><title>BRD Canvas</title>' + document.getElementById('brd-content').outerHTML);
    w.document.close();
}

function downloadBRD() {
    const resp = window.lastBRD || {};
    try {
        if (resp.download_url) {
            triggerDownload(resp.download_url, resp.filename || 'GoComet-BRD.doc');
            showNotification('Downloading BRD (.doc)…', 'info');
            return;
        }
        if (resp.fileUrl) {
            fetch(resp.fileUrl)
                .then(r => r.blob())
                .then(blob => triggerBlob(blob, resp.filename || 'GoComet-BRD.doc'))
                .catch(err => { console.warn('[BRD] fileUrl fetch failed', err); fallbackHtml(); });
            return;
        }
        const b = resp.binary || {};
        let node = (b.document || b.data || b.file || null);
        const base64 = node
          ? (node.data?.data || node.data || node.file || null)
          : null;
        if (base64) {
            const mime = node.mimeType || 'application/msword';
            const name = node.fileName || node.filename || resp.filename || 'GoComet-BRD.doc';
            const blob = base64ToBlob(base64, mime);
            triggerBlob(blob, name);
            showNotification('Downloading BRD (.doc)…', 'info');
            return;
        }
    } catch (e) {
        console.warn('[BRD] download parsing error', e);
    }
    fallbackHtml();

    function triggerDownload(href, filename) {
        const a = document.createElement('a');
        a.href = href;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    function triggerBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        triggerDownload(url, filename);
        URL.revokeObjectURL(url);
    }
    function fallbackHtml() {
        const html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>GoComet BRD</title></head><body>' +
            (document.getElementById('brd-content')?.innerHTML || '') +
            '</body></html>';
        triggerBlob(new Blob([html], { type: 'text/html' }), 'GoComet-BRD.html');
        showNotification('Downloading BRD (HTML fallback)…', 'info');
    }
}

// -------------------- Utils --------------------
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024, sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
function base64ToBlob(base64, mime = 'application/octet-stream') {
    const pure = base64.includes(',') ? base64.split(',')[1] : base64;
    const padded = pure + '='.repeat((4 - (pure.length % 4)) % 4);
    let byteString;
    try { byteString = atob(padded); } catch { byteString = atob(padded.replace(/[^A-Za-z0-9+/]/g, '')); }
    const len = byteString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) bytes[i] = byteString.charCodeAt(i);
    return new Blob([bytes], { type: mime });
}

// Initialize UI
updateGenerateButton();
setProgress(0);
</script>
</body>
</html>
